#!/usr/bin/env bash

set -e

#
# calc url for checking if application registry is accessible for download fleet maker.
#
get_app_registry_url() {
  local fm_image_name container_host install_id ping_url

  # check if preflight didn't forbidden.
  if ! enabled_in_configs 'host.preflight.enabled' 1; then
    return 0
  fi

  fm_image_name=$(get_fm_image_name)

  container_host="${fm_image_name%%/*}"
  if [ "${container_host}" != "${APP_REGISTRY_HOST}" ]; then
    # unknown registry host
    return 0
  fi

  ping_url="http://${container_host}/api/v2.0/ping"

  # get `host.install.id` from config
  install_id=$(find_in_configs_or_empty 'host.install.id' '0000000000000000')

  echo "${ping_url}?${install_id}"
}

#
# check if application registry is available to determine if it offline or online machine
#
get_app_registry_access() {
  local app_registry_url
  app_registry_url=$(get_app_registry_url)
  if [ -z "${app_registry_url}" ]; then
    echo 'unknown'
    return 0
  fi

  if run_curl_short "${app_registry_url}" > /dev/null 2>&1; then
    echo 'online'
  else
    echo 'offline'
  fi
}

#
# using docker compose to retrieve images list and pull them
#
pull_images_by_compose() {
  echo "Pull container images..."

  run_docker_compose config --images | sort -u | while read -r image; do
    docker pull "${image}" --quiet
  done

  echo "... DONE"
}
