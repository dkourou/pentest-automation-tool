#!/usr/bin/env bash

# shellcheck disable=SC2034
VENDOR_NAME="hexway"
# shellcheck disable=SC2034
VENDOR_CODE="hw"
# shellcheck disable=SC2034
BOX="bw"
# shellcheck disable=SC2034
PRODUCT_NAME="Hive"
# shellcheck disable=SC2034
SERVICE_NAME="hw-bw"
# shellcheck disable=SC2034
SERVICE_ENVVAR_PREFIX="HW_BW"


set -e

##
## Returns system user name to run in rootful mode
##
get_service_user_name() {
  
    echo "${VENDOR_CODE}-${BOX}-srv"
}

##
## calculate base target dir
##
get_service_base_dir() {
  local base_dir_var_name base_dir_provided
  base_dir_var_name="${SERVICE_ENVVAR_PREFIX}_BASE_DIR"
  service_user_name=$(get_service_user_name)

  printf -v base_dir_provided '%s' "${!base_dir_var_name}"
  if [ -n "${base_dir_provided}" ]; then
    echo "${base_dir_provided}"
    return 0
  elif [ "$(whoami)" == "${service_user_name}" ] || [ "$(whoami)" == root ]; then
    echo "/opt/${SERVICE_NAME}"
    return 0
  fi
  echo >&2 "To run ${0} under non root user ${USER} env var '${base_dir_var_name}' required"
  return 1
}

SERVICE_BASE_DIR=$(get_service_base_dir)

# shellcheck disable=SC1090
. "${SERVICE_BASE_DIR}/bin/common-functions.sh"

ping_back